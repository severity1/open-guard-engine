# Threat patterns for open-guard security engine
# Categories T1-T8 based on common AI coding assistant threats

patterns:
  # T1: Network exfiltration
  - id: T1-001
    category: T1
    name: curl_wget_request
    description: HTTP request tools that could exfiltrate data
    severity: high
    pattern: '\b(curl|wget)\s+.*https?://[^\s]+'
    extract:
      domain: 'https?://([^/:]+)'

  - id: T1-002
    category: T1
    name: netcat_connection
    description: Netcat network connection (potential reverse shell)
    severity: critical
    pattern: '\bnc\s+.+\s+\d{2,5}\b'
    extract:
      domain: '\bnc\s+.*?([a-zA-Z][a-zA-Z0-9.-]+)\s+\d+'

  - id: T1-003
    category: T1
    name: nmap_scan
    description: Network scanning tool
    severity: high
    pattern: '\bnmap\s+'

  - id: T1-004
    category: T1
    name: cloud_metadata_ssrf
    description: AWS cloud metadata endpoint access (SSRF)
    severity: critical
    pattern: '169\.254\.169\.254'

  - id: T1-005
    category: T1
    name: gcp_metadata_ssrf
    description: GCP cloud metadata endpoint access (SSRF)
    severity: critical
    pattern: '(?i)metadata\.google\.internal'

  - id: T1-006
    category: T1
    name: ecs_metadata_ssrf
    description: AWS ECS credentials endpoint access (SSRF)
    severity: critical
    pattern: '169\.254\.170\.2'

  - id: T1-007
    category: T1
    name: azure_metadata_ssrf
    description: Azure IMDS metadata endpoint access (SSRF)
    severity: critical
    pattern: '(?i)metadata\.azure\.com'

  # T2: Credential access
  - id: T2-001
    category: T2
    name: env_file_access
    description: Access to .env files containing secrets
    severity: high
    pattern: '\.env\b'

  - id: T2-002
    category: T2
    name: aws_credentials
    description: Access to AWS credential files
    severity: critical
    pattern: '\.aws/(credentials|config)\b'

  - id: T2-003
    category: T2
    name: ssh_private_key
    description: Access to SSH private keys
    severity: critical
    pattern: '\.ssh/id_(rsa|ed25519|ecdsa|dsa)\b'

  - id: T2-004
    category: T2
    name: npmrc_access
    description: Access to npm credentials
    severity: high
    pattern: '\.npmrc\b'

  - id: T2-005
    category: T2
    name: netrc_access
    description: Access to netrc credentials
    severity: high
    pattern: '\.netrc\b'

  - id: T2-006
    category: T2
    name: kube_config
    description: Access to Kubernetes config
    severity: high
    pattern: '\.kube/config\b'

  - id: T2-007
    category: T2
    name: docker_config
    description: Access to Docker credentials
    severity: high
    pattern: '\.docker/config\.json\b'

  # T3: Command injection
  - id: T3-001
    category: T3
    name: eval_execution
    description: Eval with variable expansion
    severity: critical
    pattern: '\beval\s+.*\$'

  - id: T3-002
    category: T3
    name: backtick_execution
    description: Command substitution with backticks
    severity: high
    pattern: '`[^`]+`'

  - id: T3-003
    category: T3
    name: dollar_paren_execution
    description: Command substitution with $()
    severity: medium
    pattern: '\$\([^)]+\)'

  - id: T3-004
    category: T3
    name: pipe_to_shell
    description: Piping content to shell interpreter
    severity: critical
    pattern: '\|\s*(sudo\s+)?(sh|bash|zsh|fish|ksh)\b'

  - id: T3-005
    category: T3
    name: xargs_shell
    description: Xargs with shell execution
    severity: high
    pattern: '\bxargs\s+.*\bsh\s+-c\b'

  # T4: Filesystem attacks
  - id: T4-001
    category: T4
    name: etc_write
    description: Writing to /etc directory
    severity: critical
    pattern: '^/etc/'

  - id: T4-002
    category: T4
    name: symlink_attack
    description: Creating symbolic links (potential privilege escalation)
    severity: high
    pattern: '\bln\s+-s\s+'

  - id: T4-003
    category: T4
    name: rm_rf_root
    description: Recursive deletion of root or home
    severity: critical
    pattern: '\brm\s+(-[rRfF]+\s+)*(\/\s*$|~\/?\*?|\/\*|\$HOME)'

  - id: T4-004
    category: T4
    name: chmod_sensitive
    description: Chmod on sensitive system files
    severity: high
    pattern: '\bchmod\s+\d+\s+/etc/'

  # T5: Prompt injection
  - id: T5-001
    category: T5
    name: ignore_instructions
    description: Attempt to override AI instructions
    severity: critical
    pattern: '(?i)(ignore|disregard|forget)\s+(all\s+)?(previous|prior|your)\s+(instructions?|prompts?|rules?)'

  - id: T5-002
    category: T5
    name: new_instructions
    description: Attempt to inject new instructions
    severity: critical
    pattern: '(?i)your\s+new\s+instructions?\s+(are|is)\s+to'

  - id: T5-003
    category: T5
    name: system_override
    description: Attempt to override system prompt
    severity: critical
    pattern: '(?i)^system:\s+'

  - id: T5-004
    category: T5
    name: jailbreak_keywords
    description: Known jailbreak attempt keywords
    severity: high
    pattern: '(?i)\b(DAN|jailbreak|developer\s+mode|ignore\s+safety)\b'

  - id: T5-005
    category: T5
    name: forget_everything
    description: Attempt to reset AI context
    severity: high
    pattern: '(?i)forget\s+everything'

  # T5-006 to T5-015: Direct Injection Expansion
  - id: T5-006
    category: T5
    name: system_override_extended
    description: Attempt to override system behavior
    severity: critical
    pattern: '(?i)(system\s+override|you\s+are\s+now|from\s+now\s+on\s+(you|your)|starting\s+now\s+(you|your)|effective\s+immediately|henceforth\s+(you|your))'

  - id: T5-007
    category: T5
    name: role_assumption
    description: Attempt to force AI into a new role
    severity: critical
    pattern: '(?i)(act\s+as|pretend\s+(to\s+be|you\s+are)|behave\s+as\s+if|roleplay\s+as)'

  - id: T5-008
    category: T5
    name: unrestricted_mode
    description: Attempt to remove safety restrictions
    severity: critical
    pattern: '(?i)(without\s+(any\s+)?restrictions?|bypass\s+(all\s+)?safety|no\s+restrictions?|unrestricted\s+mode|completely\s+free|totally\s+free|fully\s+free|(limitations?|restrictions?)\s+(have\s+been\s+)?(lifted|removed|disabled)|free\s+from\s+(all\s+)?(limitations?|restrictions?|rules?))'

  - id: T5-009
    category: T5
    name: training_override
    description: Attempt to override training or programming
    severity: critical
    pattern: '(?i)(ignore\s+(your\s+)?training|override\s+(your\s+)?programming|break\s+character)'

  - id: T5-010
    category: T5
    name: output_injection
    description: Attempt to inject output format
    severity: high
    pattern: '(?i)(respond\s+only\s+with|output\s+only|always\s+respond\s+with|end\s+(every|each|all)\s+(response|output|reply)\s+with|append\s+.{0,30}\s+to\s+(all\s+)?(your\s+)?(output|response)|include\s+.{0,30}\s+at\s+the\s+(start|end|beginning)\s+of|start\s+(every|each|all)\s+(response|output)\s+with)'

  - id: T5-011
    category: T5
    name: safety_disable
    description: Attempt to disable safety measures
    severity: critical
    pattern: '(?i)(disable\s+(all\s+)?safety|turn\s+off\s+(all\s+)?filters?|no\s+more\s+(rules|guidelines))'

  - id: T5-012
    category: T5
    name: instruction_reset
    description: Attempt to reset or clear instructions
    severity: critical
    pattern: '(?i)(reset\s+(your\s+)?instructions?|clear\s+(your\s+)?memory|start\s+(fresh|over))'

  - id: T5-013
    category: T5
    name: policy_violation
    description: Attempt to force policy violations
    severity: high
    pattern: '(?i)(violate\s+(your\s+)?polic(y|ies)|break\s+(your\s+)?rules|ignore\s+ethics)'

  - id: T5-014
    category: T5
    name: mode_switch
    description: Attempt to switch operational mode
    severity: high
    pattern: '(?i)(switch\s+to|enter|enable)\s+(developer|admin|debug|god|root|sudo|maintenance)\s*mode'

  - id: T5-015
    category: T5
    name: boundaries_ignore
    description: Attempt to ignore boundaries
    severity: high
    pattern: '(?i)(ignore\s+(all\s+)?boundaries|no\s+boundaries|without\s+limits)'

  # T5-016 to T5-022: Context Manipulation
  - id: T5-016
    category: T5
    name: chatml_injection
    description: ChatML format injection attempt
    severity: critical
    pattern: '<\|im_(start|end)\|>|<\|system\|>|<\|assistant\|>|<\|user\|>|<(thinking|thought|internal|scratchpad)>|\[(internal\s+)?thought[:\s]|\*thinking[:\s]'

  - id: T5-017
    category: T5
    name: instruction_delimiter
    description: Instruction delimiter injection
    severity: critical
    pattern: '(?i)\[(INST|SYS|/INST|/SYS|SYSTEM|USER|ASSISTANT)\]|###\s*(System|Instruction|Human|Assistant|User|Context)\s*:?|<<<\s*(SYSTEM|USER|ASSISTANT)\s*>>>'

  - id: T5-018
    category: T5
    name: xml_tag_injection
    description: XML-style system tag injection
    severity: critical
    pattern: '(?i)<\/?(system|instructions?|prompt|context|rules?|guidelines?)>'

  - id: T5-019
    category: T5
    name: markdown_system_injection
    description: Markdown code block with system injection
    severity: high
    pattern: '(?i)```\s*(system|instruction|prompt|config)'

  - id: T5-020
    category: T5
    name: json_role_injection
    description: JSON structure injection attempt
    severity: high
    pattern: '(?i)["'']\s*(system|instruction|role|prompt)\s*["'']\s*:'

  - id: T5-021
    category: T5
    name: comment_injection
    description: Comment-based instruction injection
    severity: medium
    pattern: '(?i)(<!--|//|#)\s*(system\s*:|ignore\s+(all|previous)|override\s+instruction)'

  - id: T5-022
    category: T5
    name: escape_sequence
    description: Escape sequence for context breaking
    severity: high
    pattern: '\\n\\n---\\n|===END===|<<<END>>>|---END OF (SYSTEM|CONTEXT)---'

  # T5-023 to T5-028: Prompt Extraction
  - id: T5-023
    category: T5
    name: reveal_prompt
    description: Attempt to reveal system prompt
    severity: high
    pattern: '(?i)(reveal|show|print|display|output)\s+(your\s+)?(system\s+)?prompt'

  - id: T5-024
    category: T5
    name: repeat_verbatim
    description: Attempt to extract via repetition
    severity: high
    pattern: '(?i)(repeat|echo|recite)\s+(everything|all|verbatim|word\s+for\s+word|exactly)'

  - id: T5-025
    category: T5
    name: position_extraction
    description: Attempt to extract by position reference
    severity: high
    pattern: '(?i)(everything|text|content)\s+(above|before|preceding)\s+(this|the|current)\s+(line|message|point)'

  - id: T5-026
    category: T5
    name: initial_extraction
    description: Attempt to extract initial instructions
    severity: high
    pattern: '(?i)(initial|first|original|starting|beginning)\s+(prompt|instructions?|configuration|setup)'

  - id: T5-027
    category: T5
    name: config_dump
    description: Attempt to dump configuration
    severity: high
    pattern: '(?i)(dump|list|show|reveal|print)\s+(your\s+)?(config(uration)?|settings?|parameters?)'

  - id: T5-028
    category: T5
    name: rules_extraction
    description: Attempt to extract rules or guidelines
    severity: high
    pattern: '(?i)(what|list|show|tell)\s+(are\s+)?(your\s+)?(rules|guidelines|constraints|limitations)'

  # T5-029 to T5-035: Social Engineering
  - id: T5-029
    category: T5
    name: authority_claim
    description: False authority claim
    severity: high
    pattern: '(?i)(i\s+am|i''m)\s+(the\s+)?(admin(istrator)?|developer|from\s+(anthropic|openai)|your\s+(creator|developer|owner))'

  - id: T5-030
    category: T5
    name: debug_pretext
    description: Debug or testing pretext
    severity: high
    pattern: '(?i)(for\s+)?(debug(ging)?|testing|diagnostic)\s+(purposes?|mode|only)'

  - id: T5-031
    category: T5
    name: urgency_manipulation
    description: Urgency-based bypass attempt
    severity: high
    pattern: '(?i)(emergency|urgent(ly)?|critical|life\s+or\s+death).{0,50}(bypass|ignore|override|skip)'

  - id: T5-032
    category: T5
    name: supervisor_claim
    description: Supervisor authorization claim
    severity: high
    pattern: '(?i)(supervisor|manager|admin|boss)\s+(authorized|approved|said|told|permitted)'

  - id: T5-033
    category: T5
    name: qa_team_claim
    description: QA or security team impersonation
    severity: high
    pattern: '(?i)(qa|security|red)\s+team.{0,30}(testing|authorized|approved)'

  - id: T5-034
    category: T5
    name: special_access
    description: Claim of special access or privileges
    severity: high
    pattern: '(?i)(special|elevated|admin)\s+(access|privileges?|permissions?|clearance)'

  - id: T5-035
    category: T5
    name: trust_exploitation
    description: Trust exploitation attempt
    severity: medium
    pattern: '(?i)(trust\s+me|you\s+can\s+trust|between\s+us|off\s+the\s+record|confidential(ly)?|you\s+(agreed|said|promised)|as\s+(we|you)\s+(discussed|agreed)|recall\s+(earlier|before|when)|previous(ly)?\s+(conversation|chat).{0,20}(you|agreed)|remember\s+(when\s+)?(you|we)\s+(agreed|said))'

  # T5-036 to T5-042: Jailbreak Variants
  - id: T5-036
    category: T5
    name: jailbreak_personas
    description: Known jailbreak persona keywords
    severity: critical
    pattern: '(?i)\b(STAN|DUDE|AIM|KEVIN|APOPHIS|OMEGA|ALPHA)\s*(mode)?\b'

  - id: T5-037
    category: T5
    name: fictional_bypass
    description: Fictional scenario bypass
    severity: high
    pattern: '(?i)(fictional|hypothetical|imaginary)\s+(scenario|world|situation|context)'

  - id: T5-038
    category: T5
    name: opposite_day
    description: Opposite or reverse instruction trick
    severity: high
    pattern: '(?i)(opposite\s+day|reverse\s+(mode|psychology)|do\s+the\s+opposite)'

  - id: T5-039
    category: T5
    name: evil_twin
    description: Evil twin or alter ego prompt
    severity: high
    pattern: '(?i)(evil\s+(twin|version|mode)|alter\s+ego|dark\s+(mode|side|version))'

  - id: T5-040
    category: T5
    name: game_framing
    description: Game-based framing to bypass rules
    severity: high
    pattern: '(?i)(let''s\s+play\s+a\s+game|roleplay\s+game|pretend\s+game|simulation\s+game)'

  - id: T5-041
    category: T5
    name: token_manipulation
    description: Token or probability manipulation
    severity: medium
    pattern: '(?i)(token\s+manipulation|logit\s+bias|probability\s+hack|temperature\s+exploit)'

  - id: T5-042
    category: T5
    name: grandfather_paradox
    description: Recursive or paradox-based bypass
    severity: medium
    pattern: '(?i)(grandfather\s+paradox|recursive\s+prompt|infinite\s+loop|this\s+statement\s+is\s+false)'

  # T5-043 to T5-048: Multi-Language Attacks
  - id: T5-043
    category: T5
    name: injection_german
    description: German language injection attempt
    severity: high
    pattern: '(?i)(ignorieren?\s+sie|vergessen?\s+sie).{0,30}anweisungen'

  - id: T5-044
    category: T5
    name: injection_french
    description: French language injection attempt
    severity: high
    pattern: '(?i)(ignorez?|oubliez?).{0,30}instructions?\s+(pr[eé]c[eé]dentes?|ant[eé]rieures?)'

  - id: T5-045
    category: T5
    name: injection_spanish
    description: Spanish language injection attempt
    severity: high
    pattern: '(?i)(ignora|olvida).{0,30}instrucciones?\s+anteriores?'

  - id: T5-046
    category: T5
    name: injection_italian
    description: Italian language injection attempt
    severity: high
    pattern: '(?i)(ignora|dimentica).{0,30}istruzioni?\s+precedenti?'

  - id: T5-047
    category: T5
    name: injection_portuguese
    description: Portuguese language injection attempt
    severity: high
    pattern: '(?i)(ignore|esque[cç]a).{0,30}instru[cç][oõ]es?\s+anteriores?'

  - id: T5-048
    category: T5
    name: injection_russian
    description: Russian language injection attempt
    severity: high
    pattern: '(?i)(игнорируй|забудь).{0,30}(инструкции|правила)'

  # T5-049 to T5-051: Encoding Detection
  - id: T5-049
    category: T5
    name: base64_payload
    description: Base64 encoded payload with suspicious keywords
    severity: high
    pattern: '(?i)(decode|base64|atob).{0,20}[A-Za-z0-9+/]{20,}={0,2}'

  - id: T5-050
    category: T5
    name: hex_payload
    description: Hexadecimal encoded payload
    severity: high
    pattern: '(?i)(hex|0x|\\x)[0-9a-fA-F]{20,}'

  - id: T5-051
    category: T5
    name: rot13_indicator
    description: ROT13 encoding indicator
    severity: medium
    pattern: '(?i)(rot13|rotate\s*13|caesar\s*cipher)'

  # T6: Privilege escalation
  - id: T6-001
    category: T6
    name: sudo_command
    description: Sudo command execution
    severity: critical
    pattern: '\bsudo\s+'

  - id: T6-002
    category: T6
    name: chmod_777
    description: World-writable permissions
    severity: high
    pattern: '\bchmod\s+777\b'

  - id: T6-003
    category: T6
    name: chmod_suid
    description: Setting SUID bit
    severity: critical
    pattern: '\bchmod\s+[47]\d{3}\b'

  - id: T6-004
    category: T6
    name: chown_root
    description: Changing ownership to root
    severity: high
    pattern: '\bchown\s+root[:\s]'

  - id: T6-005
    category: T6
    name: setuid_call
    description: Setuid system call
    severity: critical
    pattern: '\bsetuid\s*\(\s*0\s*\)'

  # T7: Persistence mechanisms
  - id: T7-001
    category: T7
    name: crontab_edit
    description: Crontab modification
    severity: high
    pattern: '\bcrontab\b'

  - id: T7-002
    category: T7
    name: shell_rc_write
    description: Writing to shell RC files
    severity: high
    pattern: '\.(bashrc|bash_profile|zshrc|profile)\b'

  - id: T7-003
    category: T7
    name: systemd_service
    description: Creating systemd service
    severity: critical
    pattern: '/etc/systemd/system/.*\.service\b'

  - id: T7-004
    category: T7
    name: init_script
    description: Creating init.d script
    severity: critical
    pattern: '/etc/init\.d/'

  - id: T7-005
    category: T7
    name: launchd_plist
    description: Creating macOS launchd plist
    severity: critical
    pattern: '/(Library|System)/Launch(Agents|Daemons)/.*\.plist\b'

  # T8: Reconnaissance
  - id: T8-001
    category: T8
    name: whoami_id
    description: User identity commands
    severity: medium
    pattern: '\b(whoami|id)\b'

  - id: T8-002
    category: T8
    name: system_info
    description: System information gathering
    severity: medium
    pattern: '\buname\s+-a\b'

  - id: T8-003
    category: T8
    name: passwd_shadow_read
    description: Reading password files
    severity: high
    pattern: '/etc/(passwd|shadow|group)\b'

  - id: T8-004
    category: T8
    name: env_dump
    description: Environment variable dump
    severity: medium
    pattern: '\b(env|printenv)\b'

  - id: T8-005
    category: T8
    name: process_list
    description: Process enumeration
    severity: low
    pattern: '\bps\s+(aux|ef)\b'

  - id: T8-006
    category: T8
    name: network_info
    description: Network configuration enumeration
    severity: medium
    pattern: '\b(netstat|ifconfig|ip\s+addr)\b'

  # T9: Output monitoring (detects leaked system prompts, credentials in AI output)
  - id: T9-001
    category: T9
    name: system_prompt_leak
    description: Potential system prompt leak in output
    severity: critical
    pattern: '(?i)SYSTEM\s*[:]\s*(You\s+are|Your\s+role|Your\s+task|You\s+must)'

  - id: T9-002
    category: T9
    name: api_key_exposure
    description: API key or secret exposure in output
    severity: critical
    pattern: '(?i)(API[_\s-]?KEY|SECRET[_\s-]?KEY|AUTH[_\s-]?TOKEN)\s*[:=]\s*[A-Za-z0-9_\-]{16,}'

  - id: T9-003
    category: T9
    name: numbered_instructions_leak
    description: Numbered instruction list leak
    severity: high
    pattern: '(?i)(instructions?|rules?|guidelines?)\s*:\s*\n\s*[1-9]\.'

  - id: T9-004
    category: T9
    name: credential_leak
    description: Password or credential exposure
    severity: critical
    pattern: '(?i)(password|passwd|secret|credential)\s*[:=]\s*[^\s]{8,}'

  - id: T9-005
    category: T9
    name: private_key_leak
    description: Private key material in output
    severity: critical
    pattern: '-----BEGIN\s+(RSA\s+)?PRIVATE\s+KEY-----'

  - id: T9-006
    category: T9
    name: aws_key_leak
    description: AWS access key in output
    severity: critical
    pattern: '(AKIA|ABIA|ACCA|ASIA)[0-9A-Z]{16}'

  - id: T9-007
    category: T9
    name: jwt_token_leak
    description: JWT token in output
    severity: high
    pattern: 'eyJ[A-Za-z0-9_-]{10,}\.eyJ[A-Za-z0-9_-]{10,}\.[A-Za-z0-9_-]+'
